@(message: String)

@main("Welcome to Keyservr") {

    <div class="splash pure-u-1" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
        <div class="pure-g-r">
            <div class="pure-u-1-3">
                <div class="l-box splash-image">
                    <img src="http://placehold.it/350x125" alt="Placeholder image for example.">
                </div>
            </div>

            <div class="pure-u-2-3">
                <div class="l-box splash-text">
                    <h1 class="splash-head">
                        Keyservr PGP Public Key server
                    </h1>

                    <h2 class="splash-subhead">
                        Easily find the public keys of the people you email using the web or an easy to usa API.
                    </h2>
                </div>
            </div>
        </div>
    </div>

    <div class="content pure-u-1">
        <div class="pure-g-r content-ribbon">
            <div class="pure-u-1-2">
              <form id="searchByEmail" class="pure-form pure-form-aligned l-box">
                <fieldset>
                  <legend>Search By Email</legend>
                  <div class="pure-group">
                    <input id="email" type="text" name="email" placeholder="Email Address" class="pure-input-1"/>
                  </div>
                  <input type="submit" class="pure-button pure-input-1 notice" value="Search" alt="Find by email"/>
                </fieldset>
              </form>

              <div id="pk" class="l-box"></div>

            </div>

            <div class="pure-u-1-2">
                <form id="savePublicKey" class="pure-form pure-form-aligned l-box">
                    <fieldset>
                        <legend>Save Public Key</legend>
                        <div class="pure-group">
                            <textarea id="keyBlock" name="keyBlock" placeholder="Paste Public Key" class="pure-input-1"></textarea>
                        </div>
                        <input type="submit" class="pure-button pure-input-1 notice" value="Save" alt="Save Public Key Block"/>
                    </fieldset>
                </form>
            </div>
        </div>

        <div class="pure-g-r">
            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Why PGP?</h3>
                    <p>
                        It's personal, it's private, it's nobody's business. It's not about having something to hide
                        it's about being able to talk with your spouse, your children, your boss without
                        anyone else reading it.
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Not Just The Good Guys</h3>
                    <p>
                      If the "good guys" can read your emails, then the "bad guys" can too. And then that information
                      might be used to steal your identity. What a hassle that would be!
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>We Can't Predict the Future</h3>
                    <p>
                      The freedoms we take for granted might not always be available to us. Making encryption
                      commonplace means that those who protect their privacy are not different from anyone else.
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Because You Can</h3>
                    <p>
                      Keeping your private communication private is your right and you shouldn't apologize for it.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="text/template" id="pk-template">
      <h3>Public Key</h3>
      <dl>
        <dt>Key Id</dt>
        <dd><%= id %></dd>
        <dt>Fingerprint</dt>
        <dd><%= fingerprint %></dd>
        <dt>Bit Strength / Algorithm</dt>
        <dd><%= bitStrength %> / <%= algorithm %></dd>
        <dt>Create Date</dt>
        <dd><%= createDate %></dd>
        <dt>User Ids</dt>
        <dd>
          <ul>
            <% _.each(userIds, function(userId) { %>
            <li><%= userId %></li>
            <% }); %>
          </ul>
        </dd>
        <dt>Signatures</dt>
        <dd>
          <ul>
            <% _.each(signatures, function(signature) { %>
            <li><%= signature.id %></li>
            <% }); %>
          </ul>
        </dd>
      </dl>
      <pre><%= rawPk %></pre>
    </script>
    <script type="text/template" id="pk-notfound-template">
        <h3>Public Key Not Found</h3>
    </script>

    <script type="text/javascript">
    (function () {
        var PublicKey = Backbone.Model.extend({
            defaults: {
                id: '',
                createDate: '',
                algorithm: '',
                fingerprint: '',
                bitStrength: 0,
                userIds: [],
                signatures: [],
                rawPk: ''
            }
        });

        var PublicKeyView = Backbone.View.extend({
            pkTpl: _.template( $('#pk-template').html() ),
            notFoundTpl: _.template( $('#pk-notfound-template').html() ),
            render: function() {
                // Don't love this, there might be a better way?
                if (this.model) {
                    this.$el.html(this.pkTpl(this.model.attributes));
                } else {
                    this.$el.html(this.notFoundTpl());
                }
                return this;
            },
            showPk: function(pk) {
                this.model = pk;
                this.render();
            }
        });

        var PublicKeySearch = Backbone.Collection.extend({
            model: PublicKey,
            searchValue: function(email) {
                this.email = email;
            },
            url: function(){
                return "/keys/email/" + this.email;
            }
        });

        var PublicKeySearchView = Backbone.View.extend({
            tagName: "form",
            initialize: function () {
                this.collection = new PublicKeySearch();
                this.collection.on('reset', this.showPk, this);
            },
            events: {
                'change #email': 'setEmail',
                'submit': 'search'
            },
            setEmail: function() {
                this.collection.searchValue(this.$el.find("#email").val());
            },
            showPk: function() {
                app.PublicKeyView.showPk(this.collection.at(0));
            },
            search: function(e) {
                e.preventDefault();
                this.collection.fetch({ reset: true });
            }
        });


        var KeyBlock = Backbone.Model.extend({
            defaults: {
                rawPk: ''
            },
            url: "/keys"
        });

        var KeyBlockView = Backbone.View.extend({
            tagName: "form",
            initialize: function (options) {
                this.model = new KeyBlock();
                this.$keyBlock = this.$el.find("#keyBlock");
            },
            events: {
                'submit': 'save',
                'blur #keyBlock': 'setKeyBlock'
            },
            setKeyBlock: function() {
                this.model.set({rawPk: this.$keyBlock.val()});
            },
            save: function(e) {
                e.preventDefault();
                var view = this;
                var jqxhr = this.model.save();
                if (jqxhr) {
                    jqxhr.success(function(data, status, jqxr) {
                        console.log(data);
                        view.$keyBlock.val("");
                    }).fail(function() {
                        console.log(arguments);
                    });
                }
            }
        });

        var app = app || {};
        app.SearchView = new PublicKeySearchView({el: $("#searchByEmail")});
        app.SearchView.render();
        app.PublicKeyView = new PublicKeyView({el: $('#pk')});
        app.KeyBlockView = new KeyBlockView({el: $("#savePublicKey"), bodyEl: $("#publicKeyBody")});
    })();
    </script>
}
