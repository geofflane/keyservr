@(message: String)

@main("Welcome to Keyservr") {

    <div class="splash pure-u-1" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
        <div class="pure-g-r">
            <div class="pure-u-1-3">
                <div class="l-box splash-image">
                    <img src="http://placehold.it/350x125" alt="Placeholder image for example.">
                </div>
            </div>

            <div class="pure-u-2-3">
                <div class="l-box splash-text">
                    <h1 class="splash-head">
                        Keyservr PGP Public Key server
                    </h1>

                    <h2 class="splash-subhead">
                        Easily find the public keys of the people you email using the web or an easy to usa API.
                    </h2>
                </div>
            </div>
        </div>
    </div>

    <div class="content pure-u-1">
        <div class="pure-g-r content-ribbon">
            <div class="pure-u-1-3">
              <form id="searchByEmail" class="pure-form pure-form-aligned l-box">
                <fieldset>
                  <legend>Search By Email</legend>
                  <div class="pure-group">
                    <input id="email" type="text" name="email" placeholder="Email Address" class="pure-input-1"/>
                  </div>
                  <input type="submit" class="pure-button pure-input-1 notice" value="Search" alt="Find by email"/>
                </fieldset>
              </form>
            </div>

            <div class="pure-u-2-3">
              <div id="pk" class="l-box"></div>
            </div>
        </div>

        <div class="pure-g-r">
            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Why PGP?</h3>
                    <p>
                        It's personal, it's private, it's nobody's business. It's not about having something to hide
                        it's about being able to talk with your spouse, your children, your boss without
                        anyone else reading it.
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Not Just The Good Guys</h3>
                    <p>
                      If the "good guys" can read your emails, then the "bad guys" can too. And then that information
                      might be used to steal your identity. What a hassle that would be!
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>We Can't Predict the Future</h3>
                    <p>
                      The freedoms we take for granted might not always be available to us. Making encryption
                      commonplace means that those who protect their privacy are not different from anyone else.
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Because You Can</h3>
                    <p>
                      Keeping your private communication private is your right and you shouldn't apologize for it.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="text/template" id="pk-template">
      <legend>Public Key</legend>
      <dl>
        <dt>Key Id</dt>
        <dd><%= id %></dd>
        <dt>Fingerprint</dt>
        <dd><%= fingerprint %></dd>
        <dt>Bit Strength / Algorithm</dt>
        <dd><%= bitStrength %> / <%= algorithm %></dd>
        <dt>Create Date</dt>
        <dd><%= createDate %></dd>
        <dt>User Ids</dt>
        <dd>
          <ul>
            <% _.each(userIds, function(userId) { %>
            <li><%= userId %></li>
            <% }); %>
          </ul>
        </dd>
        <dt>Signatures</dt>
        <dd>
          <ul>
            <% _.each(signatures, function(signature) { %>
            <li><%= signature.id %></li>
            <% }); %>
          </ul>
        </dd>
        <dt>Key</dt>
        <dd><pre><%= rawPk %></pre></dd>
      </dl>
    </script>
    <script type="text/template" id="pk-notfound-template">
        <h3>Public Key Not Found</h3>
    </script>

    <script type="text/javascript">
    (function () {
        var PublicKey = Backbone.Model.extend({
            defaults: {
                id: '',
                createDate: '',
                algorithm: '',
                fingerprint: '',
                bitStrength: 0,
                userIds: [],
                signatures: [],
                rawPk: ''
            }
        });

        var PublicKeyView = Backbone.View.extend({
            pkTpl: _.template( $('#pk-template').html() ),
            notFoundTpl: _.template( $('#pk-notfound-template').html() ),
            events: {
                'dblclick label': 'copy'
            },
            render: function() {
                if (this.model) {
                    this.$el.html(this.pkTpl(this.model.toJSON()));
                } else {
                    this.$el.html(this.notFoundTpl());
                }
                return this;
            },
            copy: function() {
                // executed when pk label is double clicked
            }
        });

        var PublicKeySearch = Backbone.Collection.extend({
            model: PublicKey,
            initialize : function(models, options){
                this.emailEl = options.emailEl;
            },
            url: function(){
                return "/keys/email/" + this.emailEl.val();
            }
        });

        var PublicKeySearchView = Backbone.View.extend({
            tagName: "form",
            initialize: function () {
                this.model = new PublicKeySearch([], {emailEl: $("#email")});
            },
            events: {
                'submit': 'search'
            },
            search: function(e) {
                e.preventDefault();
                console.log("search");
                this.model.fetch({
                    reset: true,
                    success: function(collection, response, options){
                        // Seems like there should be a way to do this with the PublicKeyView and some form of rendering
                        app.PublicKeyView.model = collection.at(0);
                        app.PublicKeyView.render();
                    }
                });
            }
        });

        var app = app || {};
        app.SearchView = new PublicKeySearchView({el: $("#searchByEmail")});
        app.SearchView.render();
        app.PublicKeyView = new PublicKeyView({el: $('#pk')});
    })();
    </script>
}
