@(message: String)

@main("Welcome to Keyservr") {

    <div class="splash pure-u-1" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
        <div class="pure-g-r">
            <div class="pure-u-1-3">
                <div class="l-box splash-image">
                    <img src="http://placehold.it/350x125" alt="Placeholder image for example.">
                </div>
            </div>

            <div class="pure-u-2-3">
                <div class="l-box splash-text">
                    <h1 class="splash-head">
                        Keyservr PGP Public Key server
                    </h1>

                    <h2 class="splash-subhead">
                        Easily find the public keys of the people you email using the web or an easy to usa API.
                    </h2>

                </div>
            </div>
        </div>
    </div>

    <div class="content pure-u-1">
        <div class="pure-g-r content-ribbon">
            <div class="pure-u-1-3">
                <div class="l-box">
                    <h4 class="content-subhead">Search By Email</h4>

                    <form id="searchByEmail">
                        <label for="email">Email Address</label>
                        <input id="email" type="text" name="email"/>
                        <input type="submit" class="pure-button primary-button" value="Search" alt="Find by email"/>
                    </form>

                </div>
            </div>

            <div class="pure-u-2-3">
                <div class="l-box">
                    <div id="pk"></div>
                </div>
            </div>
        </div>

        <div class="pure-g-r">
            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Subheading</h3>
                    <p>
                        Donec suscipit, risus vel venenatis ornare, nibh massa ultrices diam, a elementum metus felis sit amet eros. Phasellus pellentesque euismod massa sed pellentesque.
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Subheading</h3>
                    <p>
                        Donec suscipit, risus vel venenatis ornare, nibh massa ultrices diam, a elementum metus felis sit amet eros. Phasellus pellentesque euismod massa sed pellentesque.
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Subheading</h3>
                    <p>
                        Donec suscipit, risus vel venenatis ornare, nibh massa ultrices diam, a elementum metus felis sit amet eros. Phasellus pellentesque euismod massa sed pellentesque.
                    </p>
                </div>
            </div>

            <div class="pure-u-1-4">
                <div class="l-box">
                    <h3>Subheading</h3>
                    <p>
                        Donec suscipit, risus vel venenatis ornare, nibh massa ultrices diam, a elementum metus felis sit amet eros. Phasellus pellentesque euismod massa sed pellentesque.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="text/template" id="pk-template">
        <h3>Public Key</h3>
        <div>
            <dl>
                <dt>Key Id</dt>
                <dd><%= id %></dd>
                <dt>Fingerprint</dt>
                <dd><%= fingerprint %></dd>
                <dt>Algorithm</dt>
                <dd><%= algorithm %></dd>
                <dt>Bit Strength</dt>
                <dd><%= bitStrength %></dd>
                <dt>Create Date</dt>
                <dd><%= createDate %></dd>
            </dl>
            <pre><%= rawPk %></pre>
        </div>
    </script>
    <script type="text/template" id="pk-notfound-template">
        <h3>Public Key</h3>
        <div>Not Found</div>
    </script>

    <script type="text/javascript">
    (function () {
        var PublicKey = Backbone.Model.extend({
            defaults: {
                id: '',
                createDate: '',
                algorithm: '',
                fingerprint: '',
                bitStrength: 0,
                userIds: [],
                signatures: [],
                rawPk: ''
            }
        });

        var PublicKeyView = Backbone.View.extend({
            pkTpl: _.template( $('#pk-template').html() ),
            notFoundTpl: _.template( $('#pk-notfound-template').html() ),
            events: {
                'dblclick label': 'copy'
            },
            render: function() {
                if (this.model) {
                    this.$el.html(this.pkTpl(this.model.toJSON()));
                } else {
                    this.$el.html(this.notFoundTpl());
                }
                return this;
            },
            copy: function() {
                // executed when pk label is double clicked
            }
        });

        var PublicKeySearch = Backbone.Collection.extend({
            model: PublicKey,
            initialize : function(models, options){
                this.emailEl = options.emailEl;
            },
            url: function(){
                return "/keys/email/" + this.emailEl.val();
            }
        });

        var PublicKeySearchView = Backbone.View.extend({
            tagName: "form",
            initialize: function () {
                this.model = new PublicKeySearch([], {emailEl: $("#email")});
            },
            events: {
                'submit': 'search'
            },
            search: function(e) {
                e.preventDefault();
                console.log("search");
                this.model.fetch({
                    reset: true,
                    success: function(collection, response, options){
                        // Seems like there should be a way to do this with the PublicKeyView and some form of rendering
                        app.PublicKeyView.model = collection.at(0);
                        app.PublicKeyView.render();
                    }
                });
            }
        });

        var app = app || {};
        app.SearchView = new PublicKeySearchView({el: $("#searchByEmail")});
        app.SearchView.render();
        app.PublicKeyView = new PublicKeyView({el: $('#pk')});
    })();
    </script>
}
